# π€ JPA 3λ‹¨κ³„ μ‹¤μµ - ν”„λ΅μ‹, μ§€μ—° λ΅λ”©, N+1, Fetch Join

μ΄λ² μ‹¤μµμ€ JPAμ μ„±λ¥ μµμ ν™” ν•µμ‹¬ μ£Όμ μΈ **ν”„λ΅μ‹**, **μ§€μ—° λ΅λ”©**, **N+1 λ¬Έμ **, **Fetch Join**μ„ μ‹¤μ  μ½”λ“λ΅ μ‹¤ν—ν•λ©΄μ„ ν•™μµν•λ” λ° λ©μ μ΄ μμµλ‹λ‹¤.

---

## β… μ‹¤μµ ν™κ²½

- Java 17+
- Spring Boot + JPA μ„¤μ • μ™„λ£
- H2 / MySQL λ“± κ΄€κ³„ν• DB
- `spring.jpa.show-sql=true`, `hibernate.format_sql=true` κ¶μ¥
- LAZY μ „λµμ„ λ…μ‹ν•κ³  μ½μ†” λ΅κ·Έλ΅ μΏΌλ¦¬ ν™•μΈν•  κ²ƒ

---

## π“ μ‹¤μµ κ³Όμ 

### π΅ λ¬Έμ  1. ν”„λ΅μ‹ κ°μ²΄ ν™•μΈ

1. Memberμ™€ Teamμ„ μ €μ¥ν•λ‹¤.
2. μμ†μ„± μ»¨ν…μ¤νΈλ¥Ό μ΄κΈ°ν™”ν•λ‹¤.
3. Memberλ¥Ό μ΅°νν• λ’¤, `getTeam()` νΈμ¶ κ²°κ³Όκ°€ ν”„λ΅μ‹μΈμ§€ ν™•μΈν•λ‹¤.
4. μ‹¤μ  ν€ μ΄λ¦„μ„ μ¶λ ¥ν•κ³ , μΏΌλ¦¬κ°€ μ–Έμ  μ‹¤ν–‰λλ”μ§€ ν™•μΈν•λ‹¤.

---

### π΅ λ¬Έμ  2. `getReference()`λ΅ ν”„λ΅μ‹ μ§μ ‘ μƒμ„±

1. Teamμ„ ν•λ‚ μ €μ¥ν•λ‹¤.
2. `em.clear()` νΈμ¶ ν›„ `getReference()`λ¥Ό μ‚¬μ©ν•μ—¬ Teamμ ν”„λ΅μ‹ κ°μ²΄λ¥Ό μ–»λ”λ‹¤.
3. ν΄λμ¤λ…κ³Ό μ΄κΈ°ν™” μ—¬λ¶€(`Hibernate.isInitialized`)λ¥Ό ν™•μΈν•λ‹¤.
4. ν•„λ“ μ ‘κ·Ό μ‹ μΏΌλ¦¬κ°€ λ°μƒν•λ”μ§€ ν™•μΈν•λ‹¤.

---

### π΅ λ¬Έμ  3. μ§€μ—° λ΅λ”©κ³Ό N+1 λ¬Έμ  λ°μƒ

1. Team 2κ°, Member 5λ…μ„ κ°κ° ν€μ— μ†μ†λλ„λ΅ μ €μ¥ν•λ‹¤.
2. `flush()` + `clear()` μ΄ν›„ `SELECT m FROM Member m` μΌλ΅ λ¨λ“  λ©¤λ²„ μ΅°ν
3. κ° λ©¤λ²„μ ν€ μ΄λ¦„μ„ μ¶λ ¥ν•λ‹¤.
4. λ°μƒν• μΏΌλ¦¬ μλ¥Ό ν™•μΈν•κ³ , **N+1 λ¬Έμ κ°€ λ°μƒν–λ”μ§€ λ¶„μ„ν•λ‹¤**

---

### π΅ λ¬Έμ  4. Fetch JoinμΌλ΅ N+1 λ¬Έμ  ν•΄κ²°

1. JPQLλ΅ `SELECT m FROM Member m JOIN FETCH m.team` μΏΌλ¦¬λ¥Ό μ‘μ„±ν•λ‹¤.
2. Fetch JoinμΌλ΅ Memberμ™€ Teamμ„ ν• λ²μ— μ΅°νν•λ‹¤.
3. μΏΌλ¦¬ μμ™€ λ°ν™λ κ²°κ³Όλ¥Ό λΉ„κµν•κ³ , ν”„λ΅μ‹κ°€ μ•„λ‹ μ‹¤μ  κ°μ²΄κ°€ λ“¤μ–΄μ™”λ”μ§€ ν™•μΈν•λ‹¤.

---

### π΅ λ¬Έμ  5. μ»¬λ ‰μ… Fetch Joinκ³Ό μ¤‘λ³µ λ¬Έμ 

1. Team 1κ°μ— Member μ—¬λ¬ λ…μ„ μ €μ¥ν•λ‹¤.
2. `SELECT t FROM Team t JOIN FETCH t.members` λ΅ ν€μ„ μ΅°νν•λ‹¤.
3. κ°™μ€ ν€μ΄ μ—¬λ¬ λ² μ΅°νλλ”μ§€ ν™•μΈν•λ‹¤.
4. `DISTINCT` ν‚¤μ›λ“λ¥Ό μ¶”κ°€ν•κ³  κ²°κ³Ό μ°¨μ΄λ¥Ό ν™•μΈν•λ‹¤.

---

## π― μ—°μµ μ²΄ν¬λ¦¬μ¤νΈ

| ν•­λ©                          | μ™„λ£ μ—¬λ¶€ |
|-------------------------------|------------|
| ν”„λ΅μ‹ κ°μ²΄ λ°ν™ ν™•μΈ               | β… / β |
| getReference()λ΅ ν”„λ΅μ‹ μƒμ„± ν…μ¤νΈ   | β… / β |
| μ§€μ—° λ΅λ”©μΌλ΅ μΈν• N+1 ν™•μΈ          | β… / β |
| Fetch JoinμΌλ΅ N+1 ν•΄κ²°            | β… / β |
| μ»¬λ ‰μ… Fetch Join μ¤‘λ³µ ν™•μΈ λ° DISTINCT | β… / β |

---

## π§  ν•™μµ ν¬μΈνΈ μ”μ•½

- ν”„λ΅μ‹λ” μ—°κ΄€ κ°μ²΄ λ€μ‹  κ°€μ§ κ°μ²΄λ΅ μ„±λ¥ μµμ ν™”
- μ§€μ—° λ΅λ”©μ€ μ‹¤μ  ν•„λ“ μ ‘κ·Ό μ‹ DB μΏΌλ¦¬ μ‹¤ν–‰
- N+1 λ¬Έμ λ” μ§€μ—° λ΅λ”© + λ°λ³µ μ΅°νλ΅ λ°μƒ
- Fetch Joinμ€ μ΄λ¥Ό ν• λ²μ μΏΌλ¦¬λ΅ ν•΄κ²° κ°€λ¥
- μ»¬λ ‰μ… Fetch Joinμ€ μ¤‘λ³µμ£Όμ + DISTINCT ν•„μ”

---

Happy Query Optimization! π―π”¥

